# -*- mode: yaml -*-
# vim: set filetype=yaml
# atom: set grammar=yaml
# The Bogiefile template for creating migrated version of the Bogiefile
# ==============================



version: 2

vars:
  name: abc
  ba: aaaaa
  asv: asvvvv
  component: test-component
  owner: MVB585@capitalone.com
  team_name: team_name
  artemis_enabled: yes
  artemis_onboarding_enabled: yes


  OTEL_custom_opts: &OTEL_custom_opts >
    -Dotel.resource.attributes=asv=ASVREBEL,ba=BAREBEL
    -Dotel.exporter.otlp.endpoint=http://localhost:4318
    -Dotel.exporter.otlp.protocol=http/protobuf
    -Dotel.exporter_oltp_metrics_temporality_preference=delta
  OTEL_east_otel_collector: &OTEL_EAST_COLLECTOR otelservices-fs-dealer
  OTEL_west_otel_collector: &OTEL_WEST_COLLECTOR otelservices-fs-dealer-w
  OTEL_east_app_name: &otel_east_app_name dealer-insights-bff-fargate-east
  OTEL_west_app_name: &otel_west_app_name dealer-insights-bff-fargate-west

environments:
- name: dev-avenue
  gear: avenue:^1   # https://github.cloud.capitalone.com/bogie-gears/avenue#avenue-gear
  inputs:   # https://github.cloud.capitalone.com/bogie-gears/avenue#parameters
    ba: BAREBEL
    owner: asutosh.pandya@capitalone.com
    aws_account_name: app-fs-dealer-dev-1
  regions:   # https://github.cloud.capitalone.com/bogie-gears/avenue#regions
  - name: us-east-1
    roles:
    - role_name: FS-COAF-Dealer-Rebel-ECSTask-S3Access
      trust_document: iam/api/dev/trust.json
    policies:
    - policy_name: dealer-insights-bff-dev-policy
      policy_document: iam/api/dev/policy.json
    attachments:
      FS-COAF-Dealer-Rebel-ECSTask-S3Access:
        policy_names:
        - dealer-insights-bff-dev-policy
- name: qa-avenue
  gear: avenue:^1   # https://github.cloud.capitalone.com/bogie-gears/avenue#avenue-gear
  inputs:   # https://github.cloud.capitalone.com/bogie-gears/avenue#parameters
    ba: BAREBEL
    owner: MVB585@capitalone.com
    aws_account_name: app-fs-dealer-qa-barebel
  regions:   # https://github.cloud.capitalone.com/bogie-gears/avenue#regions
  - name: us-east-1
    roles:
    - role_name: FS-COAF-Dealer-Rebel-ECSTask-S3Access
      trust_document: iam/api/qa/trust.json
    policies:
    - policy_name: dealer-insights-bff-qa-policy
      policy_document: iam/api/qa/policy.json
    attachments:
      FS-COAF-Dealer-Rebel-ECSTask-S3Access:
        policy_names:
        - dealer-insights-bff-qa-policy
  - name: us-west-2
    roles:
    - role_name: FS-COAF-Dealer-Rebel-ECSTask-S3Access
      trust_document: iam/api/qa/trust.json
    policies:
    - policy_name: dealer-insights-bff-qa-policy
      policy_document: iam/api/qa/policy.json
    attachments:
      FS-COAF-Dealer-Rebel-ECSTask-S3Access:
        policy_names:
        - dealer-insights-bff-qa-policy
- name: prod-avenue
  gear: avenue:^1   # https://github.cloud.capitalone.com/bogie-gears/avenue#avenue-gear
  inputs:   # https://github.cloud.capitalone.com/bogie-gears/avenue#parameters
    ba: BAREBEL
    owner: MVB585@capitalone.com
    aws_account_name: app-fs-dealer-prd-barebel
  regions:   # https://github.cloud.capitalone.com/bogie-gears/avenue#regions
  - name: us-east-1
    roles:
    - role_name: dealer-insights-bff-prod-role
      trust_document: iam/api/prod/trust.json
    policies:
    - policy_name: dealer-insights-bff-prod-policy
      policy_document: iam/api/prod/policy.json
    attachments:
      dealer-insights-bff-prod-role:
        policy_names:
        - dealer-insights-bff-prod-policy
  - name: us-west-2
    roles:
    - role_name: dealer-insights-bff-prod-role
      trust_document: iam/api/prod/trust.json
    policies:
    - policy_name: dealer-insights-bff-prod-policy
      policy_document: iam/api/prod/policy.json
    attachments:
      dealer-insights-bff-prod-role:
        policy_names:
        - dealer-insights-bff-prod-policy

- name: dev-ecs-fargate
  gear: ecs-fargate:*   # https://github.cloud.capitalone.com/bogie-gears/ecs-fargate#ecs-fargate
  inputs:   # https://github.cloud.capitalone.com/bogie-gears/ecs-fargate#input-parameters
    asv: ASVREBEL
    ba: BAREBEL
    component: APPDEALERINSIGHTSBFF
    owner_contact: MVB585@capitalone.com
    app_name: dealer-insights-bff-fg
    application_configuration:
      traffic_routing_type: bluegreen
    service:
    - name: dealer-insights-bff-service
      iam_execution_role_arn: arn:aws:iam::770769265009:role/BAREBEL/FS-COAF-Dealer-Rebel-ECSTask-S3Access
      task_role_arn: arn:aws:iam::770769265009:role/BAREBEL/FS-COAF-Dealer-Rebel-ECSTask-S3Access
      task_desired_count: 1
      alarms:
        threshold: 10
        period: 300
        evaluation_periods: 1
        sns_topic: dealer-insights-bff-dev
      containers:
      - name: dealer-insights-bff-container
        container_port: 8080
        listener_port: 443
        listener_path: /dealer-insights-bff/*
        cpu: 512
        memory: 4096
        env:
          no_proxy: 
            127.0.0.1,localhost,169.254.169.254,169.254.170.2,s3.amazonaws.com,.s3.amazonaws.com,.kdc.capitalone.com,.cloud.capitalone.com,.clouddqt.capitalone.com,.secretsmanager.us-east-1.amazonaws.com,.secretsmanager.us-west-2.amazonaws.com
          http_proxy: http://aws-proxy-dev.cloud.capitalone.com:8099
          https_proxy: http://aws-proxy-dev.cloud.capitalone.com:8099
          CONFIG_ENV: dev
          SPRING_PROFILES_ACTIVE: dev, vault_aws_iam
          OTEL_ENABLED: true
#                NEWRELIC_ENABLED: false
          OTEL_CUSTOM_OPTS: *OTEL_custom_opts
          OTEL_ENV: dev
          LOG_BASE_DIR: /prod/msp/logs/autobahnplatform_logs
          LOG_LEVEL: INFO
        health_check:
          path: /dealer-insights-bff/actuator/health
          protocol: HTTP
        target:
          protocol: HTTP
    environment: dev
    proxy: http://aws-proxy-dev.cloud.capitalone.com:8099
  regions:
  - name: us-east-1
    vpc: fs-dealer-dev-apps-1-ue1
    subnets:
    - fs-dealer-dev-apps-1-ue1 - Enterprise-Az1
    - fs-dealer-dev-apps-1-ue1 - Enterprise-Az2
    - fs-dealer-dev-apps-1-ue1 - Enterprise-Az3

    application_configuration:
          # For more information on Fargate warranty period see - https://onepipeline.cloud.capitalone.com/pipeline/gearhouse/gear/ecs-fargate/official/details#warranty-period
          # When uncommented/not provided, it will take the gear's defaults (See links above)
          # warranty_period_duration: I-NEED-TO-BE-CHANGED
      security_groups:
      - Enterprise-AllInstances-SG-ga              #                     # TODO - Automate creating Service specific SGs
      - CoreServicesAccess-SG-ga              #                     # TODO - Automate creating Service specific SGs
      - rebel-app-tier           # TODO Please verify the APP SG        #                     # TODO - Automate creating Service specific SGs
            # USER ACTION: Add the required Security Groups for the Service here
      logging:
        default_driver: awslogs
        cloudwatch_retention_period: 14
        options:
          mode: non-blocking
          max-buffer-size: 10m
        otel_collector: otelservices-fs-dealer
        otel_cpu: 256
        otel_mem: 512
      autoscaling:
        min_capacity: 1
        max_capacity: 4
        alarms:
        - metric_name: CPUUtilization
          comparison_operator: GreaterThanOrEqualToThreshold
          threshold: 80
          statistic: Average
          namespace: AWS/ECS
          evaluation_periods: 3
          step_scaling:
            cooldown: 600
            adjustment_type: ChangeInCapacity
            step_adjustments:
            - MetricIntervalLowerBound: 0
              ScalingAdjustment: 1
        - metric_name: MemoryUtilization
          comparison_operator: LessThanOrEqualToThreshold
          threshold: 30
          statistic: Average
          namespace: AWS/ECS
          evaluation_periods: 3
          step_scaling:
            cooldown: 600
            adjustment_type: ChangeInCapacity
            step_adjustments:
            - MetricIntervalUpperBound: 0
              ScalingAdjustment: -1
        - metric_name: MemoryUtilization
          comparison_operator: GreaterThanOrEqualToThreshold
          threshold: 80
          statistic: Average
          namespace: AWS/ECS
          evaluation_periods: 3
          step_scaling:
            cooldown: 600
            adjustment_type: ChangeInCapacity
            step_adjustments:
            - MetricIntervalLowerBound: 0
              ScalingAdjustment: 1
        - metric_name: CPUUtilization
          comparison_operator: LessThanOrEqualToThreshold
          threshold: 30
          statistic: Average
          namespace: AWS/ECS
          evaluation_periods: 3
          step_scaling:
            cooldown: 600
            adjustment_type: ChangeInCapacity
            step_adjustments:
            - MetricIntervalUpperBound: 0
              ScalingAdjustment: -1

        off_hours:
          off_hours: 22-6
          off_on_weekends: true
          time_zone: America/New_York

    alb:
      security_groups:
      - Enterprise-AllInstances-SG-ga              #
      - CoreServicesAccess-SG-ga              #
      - rebel-alb           # TODO Please verify the ALB SG        #
            # USER ACTION: Add the required Security Groups for the ALB here
      listener_cert_arn: 
        arn:aws:acm:us-east-1:770769265009:certificate/a84d9a3c-b950-4ea5-8fe1-73a4df738b43

- name: qa-ecs-fargate
  gear: ecs-fargate:*   # https://github.cloud.capitalone.com/bogie-gears/ecs-fargate#ecs-fargate
  inputs:   # https://github.cloud.capitalone.com/bogie-gears/ecs-fargate#input-parameters
    asv: ASVREBEL
    ba: BAREBEL
    component: APPDEALERINSIGHTSBFF
    owner_contact: MVB585@capitalone.com
    app_name: dealer-insights-bff-fg
    application_configuration:
      traffic_routing_type: bluegreen
    service:
    - name: dealer-insights-bff-service
      iam_execution_role_arn: arn:aws:iam::770769265009:role/BAREBEL/FS-COAF-Dealer-Rebel-ECSTask-S3Access
      task_role_arn: arn:aws:iam::770769265009:role/BAREBEL/FS-COAF-Dealer-Rebel-ECSTask-S3Access
      task_desired_count: 1
      alarms:
        threshold: 10
        period: 300
        evaluation_periods: 1
        sns_topic: dealer-insights-bff-dev
      containers:
      - name: dealer-insights-bff-container
        container_port: 8080
        listener_port: 443
        listener_path: /dealer-insights-bff/*
        cpu: 512
        memory: 4096
        env:
          no_proxy: 
            127.0.0.1,localhost,169.254.169.254,169.254.170.2,s3.amazonaws.com,.s3.amazonaws.com,.kdc.capitalone.com,.cloud.capitalone.com,.clouddqt.capitalone.com,.secretsmanager.us-east-1.amazonaws.com,.secretsmanager.us-west-2.amazonaws.com
          http_proxy: http://aws-proxy-dev.cloud.capitalone.com:8099
          https_proxy: http://aws-proxy-dev.cloud.capitalone.com:8099
          CONFIG_ENV: dev
          SPRING_PROFILES_ACTIVE: dev, vault_aws_iam
          OTEL_ENABLED: true
#                NEWRELIC_ENABLED: false
          OTEL_CUSTOM_OPTS: *OTEL_custom_opts
          OTEL_ENV: dev
          LOG_BASE_DIR: /prod/msp/logs/autobahnplatform_logs
          LOG_LEVEL: INFO
        health_check:
          path: /dealer-insights-bff/actuator/health
          protocol: HTTP
        target:
          protocol: HTTP
    environment: dev
    proxy: http://aws-proxy-dev.cloud.capitalone.com:8099
  regions:
  - name: us-east-1
    vpc: fs-dealer-dev-apps-1-ue1
    subnets:
    - fs-dealer-dev-apps-1-ue1 - Enterprise-Az1
    - fs-dealer-dev-apps-1-ue1 - Enterprise-Az2
    - fs-dealer-dev-apps-1-ue1 - Enterprise-Az3

    application_configuration:
          # For more information on Fargate warranty period see - https://onepipeline.cloud.capitalone.com/pipeline/gearhouse/gear/ecs-fargate/official/details#warranty-period
          # When uncommented/not provided, it will take the gear's defaults (See links above)
          # warranty_period_duration: I-NEED-TO-BE-CHANGED
      security_groups:
      - Enterprise-AllInstances-SG-ga              #                     # TODO - Automate creating Service specific SGs
      - CoreServicesAccess-SG-ga              #                     # TODO - Automate creating Service specific SGs
      - rebel-app-tier           # TODO Please verify the APP SG        #                     # TODO - Automate creating Service specific SGs
            # USER ACTION: Add the required Security Groups for the Service here
      logging:
        default_driver: awslogs
        cloudwatch_retention_period: 14
        options:
          mode: non-blocking
          max-buffer-size: 10m
        otel_collector: otelservices-fs-dealer
        otel_cpu: 256
        otel_mem: 512
      autoscaling:
        min_capacity: 1
        max_capacity: 4
        alarms:
        - metric_name: CPUUtilization
          comparison_operator: GreaterThanOrEqualToThreshold
          threshold: 80
          statistic: Average
          namespace: AWS/ECS
          evaluation_periods: 3
          step_scaling:
            cooldown: 600
            adjustment_type: ChangeInCapacity
            step_adjustments:
            - MetricIntervalLowerBound: 0
              ScalingAdjustment: 1
        - metric_name: MemoryUtilization
          comparison_operator: LessThanOrEqualToThreshold
          threshold: 30
          statistic: Average
          namespace: AWS/ECS
          evaluation_periods: 3
          step_scaling:
            cooldown: 600
            adjustment_type: ChangeInCapacity
            step_adjustments:
            - MetricIntervalUpperBound: 0
              ScalingAdjustment: -1
        - metric_name: MemoryUtilization
          comparison_operator: GreaterThanOrEqualToThreshold
          threshold: 80
          statistic: Average
          namespace: AWS/ECS
          evaluation_periods: 3
          step_scaling:
            cooldown: 600
            adjustment_type: ChangeInCapacity
            step_adjustments:
            - MetricIntervalLowerBound: 0
              ScalingAdjustment: 1
        - metric_name: CPUUtilization
          comparison_operator: LessThanOrEqualToThreshold
          threshold: 30
          statistic: Average
          namespace: AWS/ECS
          evaluation_periods: 3
          step_scaling:
            cooldown: 600
            adjustment_type: ChangeInCapacity
            step_adjustments:
            - MetricIntervalUpperBound: 0
              ScalingAdjustment: -1

        off_hours:
          off_hours: 22-6
          off_on_weekends: true
          time_zone: America/New_York

    alb:
      security_groups:
      - Enterprise-AllInstances-SG-ga              #
      - CoreServicesAccess-SG-ga              #
      - rebel-alb           # TODO Please verify the ALB SG        #
            # USER ACTION: Add the required Security Groups for the ALB here
      listener_cert_arn: 
        arn:aws:acm:us-east-1:770769265009:certificate/a84d9a3c-b950-4ea5-8fe1-73a4df738b43
